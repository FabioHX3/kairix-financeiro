<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Kairix Financeiro</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="navbar-brand">
                <img src="/static/assets/logo.png" alt="Kairix Logo">
            </div>
            <div class="navbar-menu">
                <a href="/dashboard" class="active">Dashboard</a>
                <a href="/receitas">Receitas</a>
                <a href="/despesas">Despesas</a>
                <a href="/relatorios">RelatÃ³rios</a>
                <a href="/familia">FamÃ­lia</a>
                <a href="/meus-dados">Meus Dados</a>
                <a href="/alterar-senha">Alterar Senha</a>
                <button class="btn btn-secondary" onclick="AuthService.logout()">Sair</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding: 40px 20px;">
        <div class="d-flex justify-between align-center mb-3">
            <div>
                <h1>Dashboard Financeiro</h1>
                <p id="userGreeting" style="color: rgba(255, 255, 255, 0.7);"></p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="color: rgba(255, 255, 255, 0.8);">ðŸ“… PerÃ­odo:</label>
                <select id="mesInput" class="form-control" style="width: 150px;">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">MarÃ§o</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
                <select id="anoInput" class="form-control" style="width: 100px;">
                    <!-- SerÃ¡ preenchido via JavaScript -->
                </select>
                <button class="btn btn-primary" onclick="carregarDashboard()" style="padding: 10px 20px;">
                    Atualizar
                </button>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="grid grid-4 mb-3">
            <div class="stats-card" style="border-left: 4px solid var(--success-green);">
                <div class="stats-icon">ðŸ’°</div>
                <div class="stats-value" id="totalReceitas">R$ 0,00</div>
                <div class="stats-label">Total Receitas</div>
            </div>

            <div class="stats-card" style="border-left: 4px solid var(--danger-red);">
                <div class="stats-icon">ðŸ’¸</div>
                <div class="stats-value" id="totalDespesas">R$ 0,00</div>
                <div class="stats-label">Total Despesas</div>
            </div>

            <div class="stats-card" style="border-left: 4px solid var(--finance-blue);">
                <div class="stats-icon">ðŸ“Š</div>
                <div class="stats-value" id="saldo">R$ 0,00</div>
                <div class="stats-label">Saldo</div>
            </div>

            <div class="stats-card" style="border-left: 4px solid var(--warning-yellow);">
                <div class="stats-icon">ðŸ“ˆ</div>
                <div class="stats-value" id="totalTransacoes">0</div>
                <div class="stats-label">TransaÃ§Ãµes</div>
            </div>
        </div>

        <!-- GrÃ¡ficos -->
        <div class="grid grid-3 mb-3">
            <div class="card">
                <h3 class="mb-2" style="font-size: 1rem;">Despesas por Categoria</h3>
                <div style="max-height: 250px; position: relative;">
                    <canvas id="despesasChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="mb-2" style="font-size: 1rem;">Receitas por Categoria</h3>
                <div style="max-height: 250px; position: relative;">
                    <canvas id="receitasChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="mb-2" style="font-size: 1rem;">EvoluÃ§Ã£o Mensal</h3>
                <div style="max-height: 250px; position: relative;">
                    <canvas id="evolucaoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ãšltimas TransaÃ§Ãµes -->
        <div class="card">
            <div class="d-flex justify-between align-center mb-2">
                <h3>Ãšltimas TransaÃ§Ãµes</h3>
                <button class="btn btn-primary" onclick="abrirModalNovaTransacao()">
                    + Nova TransaÃ§Ã£o
                </button>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>DescriÃ§Ã£o</th>
                            <th>Categoria</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="ultimasTransacoes">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Nova TransaÃ§Ã£o -->
    <div id="modalNovaTransacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nova TransaÃ§Ã£o</h2>
                <button class="modal-close" onclick="fecharModal()">&times;</button>
            </div>

            <form id="formNovaTransacao">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="tipo" class="form-control" required>
                        <option value="receita">ðŸ’° Receita</option>
                        <option value="despesa">ðŸ’¸ Despesa</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="valor" class="form-control" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Categoria</label>
                    <select id="categoria" class="form-control" required></select>
                </div>

                <div class="form-group">
                    <label>Membro da FamÃ­lia (opcional)</label>
                    <select id="membroFamilia" class="form-control">
                        <option value="">Eu mesmo</option>
                    </select>
                    <small style="color: rgba(255, 255, 255, 0.6); display: block; margin-top: 5px;">
                        Selecione quem fez esta transaÃ§Ã£o
                    </small>
                </div>

                <div class="form-group">
                    <label>DescriÃ§Ã£o</label>
                    <textarea id="descricao" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="data" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>ðŸ“Ž Anexo (Foto/PDF - Opcional)</label>
                    <input type="file" id="arquivo" class="form-control" accept="image/*,.pdf">
                    <small style="color: rgba(255, 255, 255, 0.6); display: block; margin-top: 5px;">
                        Anexe nota fiscal, recibo ou comprovante (mÃ¡x. 5MB)
                    </small>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        requireAuth();

        let despesasChart, receitasChart, evolucaoChart;
        let categorias = [];
        let membrosFamilia = [];

        // InicializaÃ§Ã£o
        async function init() {
            await carregarUsuario();
            await carregarCategorias();
            await carregarMembrosFamilia();
            configurarPeriodo();
            await carregarDashboard();
        }

        async function carregarUsuario() {
            const user = await AuthService.getCurrentUser();
            if (user) {
                document.getElementById('userGreeting').textContent = `OlÃ¡, ${user.nome}!`;
            }
        }

        async function carregarCategorias() {
            const response = await fetchAPI('/api/categorias');
            categorias = await response.json();
            atualizarSelectCategorias();
        }

        async function carregarMembrosFamilia() {
            try {
                const response = await fetchAPI('/api/familia');
                membrosFamilia = await response.json();

                const select = document.getElementById('membroFamilia');
                select.innerHTML = '<option value="">Eu mesmo</option>' +
                    membrosFamilia.filter(m => m.ativo).map(m =>
                        `<option value="${m.id}">${m.nome}</option>`
                    ).join('');
            } catch (error) {
                console.error('Erro ao carregar membros da famÃ­lia:', error);
            }
        }

        function configurarPeriodo() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1; // 0-11 -> 1-12
            const anoAtual = hoje.getFullYear();

            // Preencher select de mÃªs
            document.getElementById('mesInput').value = mesAtual;

            // Preencher select de ano (Ãºltimos 5 anos + prÃ³ximo ano)
            const anoSelect = document.getElementById('anoInput');
            for (let i = -5; i <= 1; i++) {
                const ano = anoAtual + i;
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                if (i === 0) option.selected = true;
                anoSelect.appendChild(option);
            }
        }

        async function carregarDashboard() {
            const mes = document.getElementById('mesInput').value;
            const ano = document.getElementById('anoInput').value;

            const response = await fetchAPI(`/api/dashboard?mes=${mes}&ano=${ano}`);
            const data = await response.json();

            atualizarResumo(data.resumo_geral);
            atualizarGraficoDespesas(data.despesas_por_categoria);
            atualizarGraficoReceitas(data.receitas_por_categoria);
            atualizarGraficoEvolucao(data.evolucao_mensal);
            atualizarUltimasTransacoes(data.ultimas_transacoes);
        }

        function atualizarResumo(resumo) {
            document.getElementById('totalReceitas').textContent = formatarMoeda(resumo.total_receitas);
            document.getElementById('totalDespesas').textContent = formatarMoeda(resumo.total_despesas);
            document.getElementById('saldo').textContent = formatarMoeda(resumo.saldo);
            document.getElementById('totalTransacoes').textContent =
                resumo.quantidade_receitas + resumo.quantidade_despesas;
        }

        function atualizarGraficoDespesas(dados) {
            const ctx = document.getElementById('despesasChart');
            if (despesasChart) despesasChart.destroy();

            despesasChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dados.map(d => d.categoria_icone + ' ' + d.categoria_nome),
                    datasets: [{
                        data: dados.map(d => d.total),
                        backgroundColor: dados.map(d => d.categoria_cor)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#fff' } }
                    }
                }
            });
        }

        function atualizarGraficoReceitas(dados) {
            const ctx = document.getElementById('receitasChart');
            if (receitasChart) receitasChart.destroy();

            receitasChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dados.map(d => d.categoria_icone + ' ' + d.categoria_nome),
                    datasets: [{
                        data: dados.map(d => d.total),
                        backgroundColor: dados.map(d => d.categoria_cor)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#fff' } }
                    }
                }
            });
        }

        function atualizarGraficoEvolucao(dados) {
            const ctx = document.getElementById('evolucaoChart');
            if (evolucaoChart) evolucaoChart.destroy();

            const mesesBR = {
                '01': 'Jan', '02': 'Fev', '03': 'Mar', '04': 'Abr',
                '05': 'Mai', '06': 'Jun', '07': 'Jul', '08': 'Ago',
                '09': 'Set', '10': 'Out', '11': 'Nov', '12': 'Dez'
            };

            evolucaoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.map(d => {
                        const [ano, mes] = d.mes.split('-');
                        return `${mesesBR[mes]}/${ano}`;
                    }),
                    datasets: [
                        {
                            label: 'Receitas',
                            data: dados.map(d => d.receitas),
                            borderColor: '#00D95F',
                            backgroundColor: 'rgba(0, 217, 95, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Despesas',
                            data: dados.map(d => d.despesas),
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function atualizarUltimasTransacoes(transacoes) {
            const tbody = document.getElementById('ultimasTransacoes');
            tbody.innerHTML = transacoes.length === 0
                ? '<tr><td colspan="6" class="text-center">Nenhuma transaÃ§Ã£o encontrada</td></tr>'
                : transacoes.map(t => `
                    <tr>
                        <td>${formatarData(t.data_transacao)}</td>
                        <td>${t.descricao || '-'}</td>
                        <td>${t.categoria ? t.categoria.icone + ' ' + t.categoria.nome : '-'}</td>
                        <td><span class="badge badge-${t.tipo}">${t.tipo}</span></td>
                        <td style="color: ${t.tipo === 'receita' ? 'var(--success-green)' : 'var(--danger-red)'}">
                            ${t.tipo === 'receita' ? '+' : '-'} ${formatarMoeda(t.valor)}
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85rem;"
                                onclick="editarTransacao(${t.id})">Editar</button>
                        </td>
                    </tr>
                `).join('');
        }

        function atualizarSelectCategorias() {
            const tipo = document.getElementById('tipo').value;
            const select = document.getElementById('categoria');
            const categoriasFiltradas = categorias.filter(c => c.tipo === tipo);

            select.innerHTML = categoriasFiltradas.map(c =>
                `<option value="${c.id}">${c.icone} ${c.nome}</option>`
            ).join('');
        }

        document.getElementById('tipo').addEventListener('change', atualizarSelectCategorias);

        function abrirModalNovaTransacao() {
            document.getElementById('data').valueAsDate = new Date();
            document.getElementById('modalNovaTransacao').classList.add('show');
        }

        function fecharModal() {
            document.getElementById('modalNovaTransacao').classList.remove('show');
            document.getElementById('formNovaTransacao').reset();
        }

        document.getElementById('formNovaTransacao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const membroId = document.getElementById('membroFamilia').value;

            const dados = {
                tipo: document.getElementById('tipo').value,
                valor: parseFloat(document.getElementById('valor').value),
                categoria_id: parseInt(document.getElementById('categoria').value),
                descricao: document.getElementById('descricao').value,
                data_transacao: document.getElementById('data').value + 'T00:00:00',
                origem: 'web'
            };

            if (membroId) {
                dados.membro_familia_id = parseInt(membroId);
            }

            try {
                const response = await fetchAPI('/api/transacoes', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    fecharModal();
                    await carregarDashboard();
                }
            } catch (error) {
                alert('Erro ao criar transaÃ§Ã£o');
            }
        });

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }

        init();
    </script>
</body>
</html>
